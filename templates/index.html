{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}
{% block footer %}
<script src="{{ url_for('static', filename= 'js/leaflet.js') }}"></script>
<script>
    function decodeGeometry(str, precision) {
        var index = 0,
            lat = 0,
            lng = 0,
            coordinates = [],
            shift = 0,
            result = 0,
            byte = null,
            latitude_change,
            longitude_change,
            factor = Math.pow(10, precision || 6);

        // Coordinates have variable length when encoded, so just keep
        // track of whether we've hit the end of the string. In each
        // loop iteration, a single coordinate is decoded.
        while (index < str.length) {

            // Reset shift, result, and byte
            byte = null;
            shift = 0;
            result = 0;

            do {
                byte = str.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);

            latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

            shift = result = 0;

            do {
                byte = str.charCodeAt(index++) - 63;
                result |= (byte & 0x1f) << shift;
                shift += 5;
            } while (byte >= 0x20);

            longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

            lat += latitude_change;
            lng += longitude_change;

            coordinates.push([lat / factor, lng / factor]);
        }

        return coordinates;
    }
</script>
<script>
    const map = L.map('map').setView([-7.282026, 112.794915], 16);

    const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    {% if result %}
    var polyline, randomColor;
    {% for g in result['geometry'] %}
        polyline = decodeGeometry("{{ g }}", 5);
        randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
        L.polyline(polyline, {color: randomColor}).addTo(map);
    {% endfor %}
    {% for w in result['waypoints'] %}
    L.marker([{{w[0]}}, {{w[1]}}]).addTo(map);
    {% endfor %}
    {% endif %}

    var state_drop_pin = -1;
    function dropPin(num) {
        state_drop_pin = num;
        // if (num == 0) {
        //     alert("Click on map for depot location!");
        // }
        // else {
        //     alert("Click on map for destination " + (num-1) + "!");
        // }
    }

    map.on('click', function(e) {
        if (state_drop_pin != -1) {
            var popLocation= e.latlng;
            L.marker(popLocation).addTo(map);
            if (state_drop_pin == 0) {
                $("#depot-lat").val(popLocation.lat);
                $("#depot-lng").val(popLocation.lng);
            }
            else {
                $("#destination-lat-" + state_drop_pin).val(popLocation.lat);
                $("#destination-lng-" + state_drop_pin).val(popLocation.lng);
            }
            state_drop_pin = -1;     
        }
    });
</script>
<script>
    $("#my-location").click(function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                let lat = position.coords.latitude;
                let lng = position.coords.longitude;

                map.setView([lat, lng], 16);
                L.marker([lat, lng]).addTo(map);
            });
        }
        else alert("Sorry, Geolocation is not supported by your browser.");
    });

    var numDestination = 1;
    function addDestination() {
        numDestination += 1;
        $("#destination-list").append('<div class="form-group">\
                        <label>Destination ' + (numDestination-1) + '</label>\
                        <div class="row">\
                            <div class="col">\
                                <input type="text" class="form-control" name="destination-lat[]" id="destination-lat-' + numDestination + '" placeholder="Enter latitude">\
                            </div>\
                            <div class="col">\
                                <input type="text" class="form-control" name="destination-lng[]" id="destination-lng-' + numDestination + '" placeholder="Enter longtitude">\
                            </div>\
                            <div class="col">\
                                <button type="button" class="btn btn-success" onclick="dropPin(' + numDestination + ')">G</button>\
                            </div>\
                            <div class="col">\
                                <input type="number" class="form-control" name="capacity[]" placeholder="Enter capacity">\
                            </div>\
                        </div>\
                    </div>');
    }
</script>
{% endblock %}
{% block title %}Location-based Services{% endblock %}
{% block content %}
    <h1>CVRP Prototype</h1>
    <div class="row">
        <div class="col">
            <button id="my-location" class="btn btn-primary">My location</button>
            <p>Let's go simulate it! ehe</p>
            <form method="POST" action="/run">
                <label>Depot Address</label>
                <div class="form-group">
                    <div class="row">
                        <div class="col">
                            <input type="text" class="form-control" name="depot-lat" id="depot-lat" placeholder="Enter latitude">
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" name="depot-lng" id="depot-lng" placeholder="Enter longtitude">
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-success" onclick="dropPin(0)">G</button>
                        </div>
                    </div>
                </div>
                <div id="destination-list">

                </div>
                <button type="button" class="btn btn-info" onclick="addDestination()">Add Destination</button>
                <button type="submit" class="btn btn-primary float-right mt-2">Run!</button>
            </form>
        </div>
        <div class="col">
            <div id="map"></div>
        </div>
    </div>
{% endblock %}