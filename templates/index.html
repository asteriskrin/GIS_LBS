{% extends 'base.html' %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
{% endblock %}
{% block footer %}
<script src="{{ url_for('static', filename= 'js/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='js/polyline.js') }}"></script>
<script>
    const map = L.map('map').setView([-7.282026, 112.794915], 16);

    const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    {% if result %}
    var decoded_polyline, created_marker, randomColor;
    {% for g in result['geometry'] %}
        decoded_polyline = polyline.decode('{{ g }}');
        console.log(decoded_polyline)
        randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
        L.polyline(decoded_polyline, {color: randomColor}).addTo(map);
    {% endfor %}
    {% for w in result['waypoints'] %}
    created_marker = L.marker([{{w[0]}}, {{w[1]}}]).addTo(map);
    created_marker.bindPopup("{{ w[3] }} / {{ w[2] }} capacity");
    {% endfor %}
    {% endif %}

    var state_drop_pin = -1;
    function dropPin(num) {
        state_drop_pin = num;
        // if (num == 0) {
        //     alert("Click on map for depot location!");
        // }
        // else {
        //     alert("Click on map for destination " + (num-1) + "!");
        // }
    }

    map.on('click', function(e) {
        if (state_drop_pin != -1) {
            var popLocation= e.latlng;
            L.marker(popLocation).addTo(map);
            if (state_drop_pin == 0) {
                $("#depot-lat").val(popLocation.lat);
                $("#depot-lng").val(popLocation.lng);
            }
            else {
                $("#destination-lat-" + state_drop_pin).val(popLocation.lat);
                $("#destination-lng-" + state_drop_pin).val(popLocation.lng);
            }
            state_drop_pin = -1;     
        }
    });
</script>
<script>
    $("#my-location").click(function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                let lat = position.coords.latitude;
                let lng = position.coords.longitude;

                map.setView([lat, lng], 16);
                L.marker([lat, lng]).addTo(map);
            });
        }
        else alert("Sorry, Geolocation is not supported by your browser.");
    });

    var numDestination = 1;
    function addDestination() {
        numDestination += 1;
        $("#destination-list").append('<div class="form-group">\
                        <div class="row">\
                            <div class="col">\
                                # ' + (numDestination-1) + '\
                            </div>\
                            <div class="col">\
                                <input type="text" class="form-control form-control-sm" name="destination-lat[]" id="destination-lat-' + numDestination + '" placeholder="Latitude">\
                            </div>\
                            <div class="col">\
                                <input type="text" class="form-control form-control-sm" name="destination-lng[]" id="destination-lng-' + numDestination + '" placeholder="Longtitude">\
                            </div>\
                            <div class="col">\
                                <input type="number" class="form-control form-control-sm" name="destination-cap[]" placeholder="Capacity">\
                            </div>\
                            <div class="col">\
                                <button type="button" class="btn btn-success btn-sm" onclick="dropPin(' + numDestination + ')"><img src="{{ url_for("static", filename="css/icons/icons8-location-50.png") }}" width="18px"></button>\
                            </div>\
                        </div>\
                    </div>');
    }
</script>
{% endblock %}
{% block title %}Location-based Services{% endblock %}
{% block content %}
    <h1>CVRP Prototype</h1>
    <div class="row">
        <div class="col">
            <button id="my-location" class="btn btn-primary">My location</button>
            <p>Let's go simulate it! ehe</p>
            <form method="POST" action="/run">
                <div class="form-group">
                    <div class="row">
                        <div class="col">
                            Depot
                        </div>
                        <div class="col">
                            <input type="text" class="form-control form-control-sm" name="depot-lat" id="depot-lat" placeholder="Latitude">
                        </div>
                        <div class="col">
                            <input type="text" class="form-control form-control-sm" name="depot-lng" id="depot-lng" placeholder="Longtitude">
                        </div>
                        <div class="col">
                            <input type="text" class="form-control form-control-sm" name="vehicle-capacity" id="vehicle-capacity" placeholder="Capacity">
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-success btn-sm" onclick="dropPin(0)"><img src="{{ url_for('static', filename='css/icons/icons8-location-50.png') }}" width="18px"></button>
                        </div>
                    </div>
                </div>
                <div id="destination-list">

                </div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addDestination()">+ Destination</button>
                <button type="submit" class="btn btn-primary btn-sm">Run</button>
            </form>
        </div>
        <div class="col">
            <div id="map"></div>
        </div>
    </div>
{% endblock %}